# 人脸检测与识别系统技术报告

## 一、系统概述

本系统采用**两阶段级联架构**实现视频中的人脸检测与身份识别：

1. **第一阶段 - 人脸检测**：使用 YOLO（You Only Look Once）目标检测模型定位视频帧中的人脸位置
2. **第二阶段 - 人脸识别**：使用 InsightFace 深度学习模型提取人脸特征，与预建的人脸数据库进行相似度匹配，识别人物身份

这种级联设计将复杂的身份识别任务分解为两个专门的子任务，充分发挥各模型的优势。

---

## 二、人脸检测模块

### 2.1 技术选型

采用 **YOLOv8n-face** 模型进行人脸检测。YOLO 系列是当前最流行的实时目标检测算法，具有以下特点：

- **单阶段检测**：直接在特征图上预测边界框和类别，无需候选区域生成，检测速度快
- **端到端训练**：整个网络统一训练，检测精度高
- **多尺度特征融合**：通过 FPN（Feature Pyramid Network）结构处理不同大小的人脸

### 2.2 检测流程

```
输入图像 → YOLO网络 → 特征提取 → 边界框预测 → NMS后处理 → 人脸位置
                ↓
         CSPDarknet骨干网络
                ↓
         PANet特征金字塔
                ↓
         检测头(3个尺度)
```

### 2.3 模型微调

为适应特定场景（如教室环境），对预训练模型进行了微调：

1. **数据准备**：从目标场景视频中抽取关键帧，使用 LabelImg 工具进行人脸边界框标注
2. **数据格式**：采用 YOLO 标注格式（`<class_id> <x_center> <y_center> <width> <height>`，归一化坐标）
3. **训练配置**：基于 YOLOv8n-face 预训练权重，在自定义数据集上进行 50 轮微调

### 2.4 目标跟踪

系统集成了 **ByteTrack** 多目标跟踪算法，实现跨帧人脸关联：

- 为每个检测到的人脸分配唯一的 Track ID
- 即使人脸短暂被遮挡，也能保持身份的连续性
- 支持设置跟踪缓冲帧数（track_buffer），控制轨迹丢失后的保持时间

---

## 三、人脸识别模块

### 3.1 技术选型

采用 **InsightFace** 开源人脸分析框架，使用 **ArcFace** 损失函数训练的识别模型：

- **模型架构**：基于 ResNet 的深度卷积网络
- **特征维度**：512 维人脸特征向量（embedding）
- **损失函数**：ArcFace（Additive Angular Margin Loss），增强类间可分性

### 3.2 识别流程

```
人脸裁剪图 → 人脸对齐 → 特征提取 → 相似度计算 → 身份匹配
     ↓           ↓           ↓           ↓
  YOLO检测框   5点关键点    ResNet网络   余弦相似度
              仿射变换     512维向量     阈值判断
```

#### 3.2.1 人脸对齐

InsightFace 内置人脸对齐模块，通过检测 5 个关键点（双眼、鼻尖、嘴角）进行仿射变换，将人脸校正到标准姿态，消除姿态变化对识别的影响。

#### 3.2.2 特征提取

使用预训练的 `buffalo_sc` 模型（轻量级）或 `buffalo_l` 模型（高精度）提取 512 维特征向量，该向量编码了人脸的身份信息。

#### 3.2.3 相似度计算

采用**余弦相似度**衡量两个特征向量的相似程度：

$$\text{similarity} = \frac{\vec{a} \cdot \vec{b}}{|\vec{a}| \times |\vec{b}|}$$

相似度范围为 [-1, 1]，系统将其映射到 [0, 1] 区间，并设置阈值（默认 0.15）判断是否为同一人。

### 3.3 人脸数据库

系统支持两种人脸库组织方式：

**方式一：单人单照片**
```
photo_folder/
├── 张三.jpg      ← 文件名作为人名
├── 李四.png
└── 王五.jpeg
```

**方式二：单人多照片**
```
photo_folder/
├── 张三/          ← 文件夹名作为人名
│   ├── img1.jpg   ← 多张照片取平均特征
│   └── img2.jpg
└── 李四/
    └── photo.jpg
```

多照片模式下，系统对同一人的所有照片提取特征后取平均值，提高识别鲁棒性。

---

## 四、系统集成与优化

### 4.1 视频处理流程

```
视频输入 → 逐帧读取 → 人脸检测 → 目标跟踪 → 人脸识别 → 结果可视化 → 视频输出
                           ↓                      ↓
                      YOLO检测               InsightFace匹配
                           ↓                      ↓
                      ByteTrack              特征库比对
```

### 4.2 性能优化策略

1. **跳帧识别**：每 N 帧（默认 3 帧）进行一次 InsightFace 识别，中间帧复用缓存结果
2. **批量处理**：将单帧内的多个人脸批量送入识别模型，减少 GPU 调用开销
3. **结果缓存**：基于 Track ID 缓存识别结果，避免重复计算
4. **并行推理**：使用多线程并行处理多个人脸的特征提取

### 4.3 可视化输出

- **边界框绘制**：已识别人员显示绿色框，未识别显示黄色框
- **跟踪模式**：每个 Track ID 分配独特颜色
- **标签显示**：使用 PIL 库渲染中文姓名标签
- **统计信息**：实时显示处理帧率、检测人数、识别结果

---

## 五、关键技术指标

| 指标 | 数值 |
|------|------|
| 人脸检测模型 | YOLOv8n-face |
| 人脸识别模型 | InsightFace (buffalo_sc/buffalo_l) |
| 特征向量维度 | 512 维 |
| 默认置信度阈值 | 0.3 |
| 默认相似度阈值 | 0.15 |
| 跟踪算法 | ByteTrack |
| 支持的视频格式 | MP4, AVI, MOV, MKV |

---

## 六、使用示例

```bash
python yolo_face_detector.py \
    --input video.mp4 \
    --output result.mp4 \
    --model-path models/yolov8n-face.pt \
    --photo-folder classmate_photos/ \
    --track \
    --conf 0.3
```

**参数说明：**
- `--input`：输入视频路径
- `--output`：输出视频路径
- `--model-path`：YOLO 人脸检测模型路径
- `--photo-folder`：人脸数据库目录
- `--track`：启用目标跟踪
- `--conf`：检测置信度阈值

---

## 七、总结

本系统通过 YOLO + InsightFace 的级联架构，实现了高效准确的视频人脸检测与识别。YOLO 负责快速定位人脸位置，InsightFace 负责精确的身份匹配，两者结合既保证了实时性，又保证了识别精度。通过模型微调、跳帧优化、结果缓存等策略，系统能够满足实际应用场景的性能需求。

