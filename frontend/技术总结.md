# 前端展示系统技术总结

## 一、系统概述

本系统是一个基于 Web 的**课堂视频人脸检测与识别展示平台**，采用前后端分离架构，用户可通过浏览器上传视频、配置检测参数，后端调用深度学习模型进行人脸检测与识别，最终将处理后的视频返回前端展示。

## 二、技术架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端 (index.html)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  视频上传    │  │  参数配置    │  │  结果预览 & 下载         │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└──────────────────────────┬──────────────────────────────────────┘
                           │ HTTP POST (FormData)
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│                   后端 API (api_server.py)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  FastAPI    │  │  文件管理    │  │  调用检测脚本            │  │
│  │  CORS 跨域  │  │  视频转码    │  │  返回结果 URL           │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└──────────────────────────┬──────────────────────────────────────┘
                           │ subprocess
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│              检测脚本 (yolo_face_detector.py)                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │  YOLO 检测  │  │ InsightFace │  │  视频处理 & 标注         │  │
│  │  微调模型   │  │  人脸识别    │  │  输出结果视频            │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

## 三、前端技术栈

### 3.1 核心技术

| 技术 | 说明 |
|------|------|
| HTML5 | 页面结构，使用语义化标签 |
| CSS3 | 暗色主题 UI，响应式布局 |
| JavaScript (ES6+) | 交互逻辑，异步请求 |
| Fetch API | 与后端 API 通信 |
| FormData | 封装视频文件和参数 |

### 3.2 界面设计特点

- **暗色主题**：深蓝色背景 (#0f172a)，护眼舒适
- **卡片式布局**：CSS Grid 实现响应式两栏布局
- **渐变按钮**：蓝紫渐变主按钮，视觉突出
- **滑块控件**：直观调节置信度和相似度阈值
- **实时预览**：上传视频后可立即预览

### 3.3 主要功能

1. **视频上传**：支持拖拽或点击选择视频文件
2. **参数配置**：
   - 开始检测时间（支持秒数或 hh:mm:ss 格式）
   - 最大处理帧数
   - 模型选择（YOLOv8n-face / YOLOv12l-face）
   - 置信度阈值（0-1）
   - 相似度阈值（0-1）
3. **结果展示**：检测完成后自动加载结果视频
4. **视频下载**：提供下载链接

## 四、后端技术栈

### 4.1 核心技术

| 技术 | 版本 | 说明 |
|------|------|------|
| Python | 3.9+ | 编程语言 |
| FastAPI | - | 高性能异步 Web 框架 |
| Uvicorn | - | ASGI 服务器 |
| python-multipart | - | 处理文件上传 |
| FFmpeg | - | 视频转码 (H.264) |

### 4.2 API 接口

#### POST `/api/detect`

**请求参数 (FormData)：**

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| video | File | ✓ | - | 视频文件 |
| start_time | string | ✗ | "0" | 开始时间（秒） |
| model | string | ✗ | "yolov8n-face" | 模型类型 |
| conf | float | ✗ | 0.30 | 置信度阈值 |
| similarity_threshold | float | ✗ | 0.61 | 相似度阈值 |
| max_frames | int | ✗ | null | 最大处理帧数 |

**响应示例：**

```json
{
  "outputVideoUrl": "http://127.0.0.1:8000/outputs/xxx_result_h264.mp4",
  "originalVideoUrl": "http://127.0.0.1:8000/outputs/xxx_result.mp4",
  "message": "检测成功",
  "transcoded": true
}
```

### 4.3 核心功能模块

1. **文件管理**
   - 上传视频保存到 `uploads/` 目录
   - 处理结果保存到 `outputs/` 目录
   - 文件名安全处理，防止路径注入

2. **视频转码**
   - 使用 FFmpeg 将输出视频转码为 H.264 格式
   - 提升浏览器兼容性（尤其是 Safari）
   - 参数：`-c:v libx264 -preset fast -crf 23`

3. **CORS 跨域**
   - 允许任意来源访问，方便开发调试
   - 支持所有 HTTP 方法和请求头

4. **静态文件服务**
   - 挂载 `/outputs` 路径提供结果视频访问
   - 根路径 `/` 直接返回前端页面

## 五、检测模型

### 5.1 人脸检测模型

| 模型 | 说明 | 特点 |
|------|------|------|
| YOLOv8n-face | 轻量级人脸检测 | 速度快，适合实时检测 |
| YOLOv12l-face | 大型人脸检测 | 精度高，检测效果更好 |

两个模型均经过**课堂场景微调**，针对教室环境优化。

### 5.2 人脸识别

- **InsightFace**：基于深度学习的人脸特征提取
- **buffalo_sc 模型**：轻量级人脸识别模型
- **相似度匹配**：与照片库进行特征比对，识别学生身份

## 六、部署与运行

### 6.1 依赖安装

```bash
pip install fastapi uvicorn python-multipart
pip install ultralytics insightface onnxruntime-gpu
# 注意：需要 numpy<2.0 以兼容 insightface
pip install "numpy<2.0"
```

### 6.2 启动服务

```bash
cd frontend
uvicorn api_server:app --host 0.0.0.0 --port 8000
```

### 6.3 访问地址

- 前端页面：http://127.0.0.1:8000/
- API 接口：http://127.0.0.1:8000/api/detect

## 七、目录结构

```
frontend/
├── api_server.py      # 后端 API 服务
├── index.html         # 前端页面
├── uploads/           # 上传的视频文件
├── outputs/           # 处理后的结果视频
└── 技术总结.md         # 本文档
```

## 八、技术亮点

1. **前后端一体化部署**：单个服务同时提供前端页面和 API 接口
2. **异步处理**：FastAPI 原生支持异步，提升并发性能
3. **自动转码**：检测 FFmpeg 并自动转码为 H.264，确保浏览器兼容
4. **参数灵活**：支持多种检测参数配置，满足不同需求
5. **中文支持**：界面和人脸标注均支持中文显示

## 九、后续优化方向

1. **进度反馈**：添加 WebSocket 实时推送检测进度
2. **批量处理**：支持多视频同时上传处理
3. **历史记录**：保存检测历史，方便回溯查看
4. **用户认证**：添加登录功能，保护数据安全
5. **GPU 调度**：多任务排队，合理分配 GPU 资源

