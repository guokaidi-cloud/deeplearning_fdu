<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>视频检测前端面板</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Inter", "PingFang SC", system-ui, -apple-system, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: #0f172a;
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    main {
      width: min(1080px, 100%);
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 80px rgba(0, 0, 0, 0.35);
    }
    h1 {
      margin-top: 0;
      font-size: 24px;
      letter-spacing: 0.02em;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px;
      margin-top: 12px;
    }
    .card {
      background: #0b1220;
      border: 1px solid #1f2937;
      border-radius: 12px;
      padding: 16px;
    }
    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
      color: #cbd5e1;
    }
    label {
      display: block;
      font-size: 14px;
      margin-bottom: 6px;
      color: #94a3b8;
    }
    input[type="file"],
    input[type="text"],
    input[type="number"],
    select {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border: 1px solid #1f2937;
      border-radius: 10px;
      background: #0f172a;
      color: #e2e8f0;
      outline: none;
    }
    input[type="range"] {
      width: 100%;
    }
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    button {
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, background 160ms ease;
    }
    .primary {
      background: linear-gradient(120deg, #2563eb, #7c3aed);
      color: #fff;
    }
    .ghost {
      background: transparent;
      border: 1px solid #1f2937;
      color: #cbd5e1;
    }
    button:hover {
      transform: translateY(-1px);
    }
    video {
      width: 100%;
      border-radius: 10px;
      background: #000;
    }
    .status {
      margin-top: 10px;
      font-size: 14px;
      color: #a5b4fc;
      min-height: 20px;
      white-space: pre-line;
    }
    .hidden {
      display: none;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #111827;
      border: 1px solid #1f2937;
      font-size: 12px;
      color: #cbd5e1;
    }
    .footer {
      margin-top: 18px;
      color: #6b7280;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <main>
    <h1>课堂视频检测面板</h1>
    <div class="grid">
      <section class="card">
        <h2>上传与参数</h2>
        <div>
          <label for="videoInput">视频文件</label>
          <input id="videoInput" type="file" accept="video/*">
          <div id="fileName" class="pill" style="margin-top:8px;">未选择文件</div>
        </div>

        <div style="margin-top:12px;">
          <label for="startTime">开始检测时间（秒或hh:mm:ss）</label>
          <input id="startTime" type="text" placeholder="例如：3600 或 01:00:00" value="0">
        </div>

        <div style="margin-top:12px;">
          <label for="maxFrames">最大处理帧数（留空处理完整视频）</label>
          <input id="maxFrames" type="number" min="1" placeholder="例如：500">
        </div>

        <div style="margin-top:12px;">
          <label for="model">使用模型</label>
          <select id="model">
            <option value="opencv">OpenCV Haar/LBP</option>
            <option value="yolov8">YOLOv8-face</option>
            <option value="yolov12">YOLOv12-face</option>
            <option value="clip">CLIP one-shot</option>
          </select>
        </div>

        <div style="margin-top:12px;">
          <label for="conf">置信度阈值：<span id="confValue">0.25</span></label>
          <input id="conf" type="range" min="0" max="1" step="0.01" value="0.25">
        </div>

        <div class="row" style="margin-top:16px; justify-content:flex-end;">
          <button id="resetBtn" class="ghost">重置</button>
          <button id="runBtn" class="primary">开始检测</button>
        </div>
        <div id="status" class="status"></div>
      </section>

      <section class="card">
        <h2>预览 / 结果</h2>
        <video id="preview" controls class="hidden"></video>
        <div id="previewPlaceholder" style="color:#6b7280; font-size:14px;">上传视频后可预览</div>
        <hr style="border:none; border-top:1px solid #1f2937; margin:12px 0;">
        <video id="resultVideo" controls class="hidden"></video>
        <a id="downloadLink" class="pill hidden" href="#" download style="margin-top:8px;">下载结果视频</a>
      </section>
    </div>
    <div class="footer">
      前端仅负责上传与展示，需在后端实现 /api/detect 接口：接收 FormData(video, start_time, model, conf)，返回 { outputVideoUrl } 或直接流式传回处理后的视频。
    </div>
  </main>

  <script>
    const API_ENDPOINT = "http://127.0.0.1:8000/api/detect"; // 后端检测接口地址，可按需修改

    const videoInput = document.getElementById("videoInput");
    const startTimeInput = document.getElementById("startTime");
    const maxFramesInput = document.getElementById("maxFrames");
    const modelSelect = document.getElementById("model");
    const confRange = document.getElementById("conf");
    const confValue = document.getElementById("confValue");
    const runBtn = document.getElementById("runBtn");
    const resetBtn = document.getElementById("resetBtn");
    const statusEl = document.getElementById("status");
    const fileNameEl = document.getElementById("fileName");
    const previewVideo = document.getElementById("preview");
    const previewPlaceholder = document.getElementById("previewPlaceholder");
    const resultVideo = document.getElementById("resultVideo");
    const downloadLink = document.getElementById("downloadLink");

    confRange.addEventListener("input", () => {
      confValue.textContent = Number(confRange.value).toFixed(2);
    });

    videoInput.addEventListener("change", () => {
      const file = videoInput.files?.[0];
      if (!file) {
        fileNameEl.textContent = "未选择文件";
        previewVideo.classList.add("hidden");
        previewPlaceholder.classList.remove("hidden");
        previewVideo.removeAttribute("src");
        previewVideo.load();
        return;
      }
      fileNameEl.textContent = file.name;
      const objectUrl = URL.createObjectURL(file);
      previewVideo.src = objectUrl;
      previewVideo.classList.remove("hidden");
      previewPlaceholder.classList.add("hidden");
    });

    resetBtn.addEventListener("click", () => {
      videoInput.value = "";
      startTimeInput.value = "0";
      modelSelect.value = "opencv";
      confRange.value = "0.25";
      confValue.textContent = "0.25";
      maxFramesInput.value = "";
      statusEl.textContent = "";
      resultVideo.classList.add("hidden");
      resultVideo.removeAttribute("src");
      resultVideo.load();
      downloadLink.classList.add("hidden");
      fileNameEl.textContent = "未选择文件";
      previewVideo.classList.add("hidden");
      previewPlaceholder.classList.remove("hidden");
      previewVideo.removeAttribute("src");
      previewVideo.load();
    });

    runBtn.addEventListener("click", async () => {
      const file = videoInput.files?.[0];
      if (!file) {
        statusEl.textContent = "请先选择视频文件。";
        return;
      }

      const startSeconds = parseStartTime(startTimeInput.value);
      if (startSeconds < 0) {
        statusEl.textContent = "开始时间格式不正确，请输入秒或 hh:mm:ss。";
        return;
      }

      const formData = new FormData();
      formData.append("video", file);
      formData.append("start_time", String(startSeconds));
      formData.append("model", modelSelect.value);
      formData.append("conf", confRange.value);
      if (maxFramesInput.value.trim() !== "") {
        formData.append("max_frames", maxFramesInput.value.trim());
      }

      setBusy(true, "正在上传并启动检测...");
      try {
        const resp = await fetch(API_ENDPOINT, {
          method: "POST",
          body: formData,
        });
        if (!resp.ok) {
          throw new Error(`接口返回 ${resp.status}`);
        }
        // 期望后端返回 { outputVideoUrl: "..." }
        const data = await resp.json();
        if (data.outputVideoUrl) {
          resultVideo.src = data.outputVideoUrl;
          resultVideo.classList.remove("hidden");
          resultVideo.load();
          downloadLink.href = data.outputVideoUrl;
          downloadLink.classList.remove("hidden");
        }
        setBusy(false, data.message || "检测完成，结果已更新。");
      } catch (err) {
        console.error(err);
        setBusy(false, `检测失败：${err.message || err}`);
      }
    });

    function setBusy(isBusy, text) {
      statusEl.textContent = text || "";
      runBtn.disabled = isBusy;
      resetBtn.disabled = isBusy;
      runBtn.textContent = isBusy ? "检测中..." : "开始检测";
    }

    function parseStartTime(input) {
      if (!input) return 0;
      const trimmed = String(input).trim();
      if (/^\d+(\.\d+)?$/.test(trimmed)) return Number(trimmed);
      const parts = trimmed.split(":").map(Number);
      if (parts.some(Number.isNaN)) return -1;
      if (parts.length === 3) {
        const [hh, mm, ss] = parts;
        return hh * 3600 + mm * 60 + ss;
      }
      if (parts.length === 2) {
        const [mm, ss] = parts;
        return mm * 60 + ss;
      }
      return -1;
    }
  </script>
</body>
</html>

